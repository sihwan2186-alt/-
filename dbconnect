package dbconnect;

import java.sql.*;

public class DBConnect {
    
    // Singleton ì¸ìŠ¤í„´ìŠ¤
    private static DBConnect instance;
    
    // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´
    private static final String DB_URL = "jdbc:mysql://localhost:3306/soulfoodb?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Seoul";
    private static final String DB_USER = "root";
    private static final String DB_PASSWORD = "pororo17@"; // â† ì‹¤ì œ MySQL ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•˜ì„¸ìš”
    private static final String DB_DRIVER = "com.mysql.cj.jdbc.Driver";
    
    // Connection ê°ì²´
    private Connection connection;
    
    /**
     * Private ìƒì„±ì - Singleton íŒ¨í„´
     */
    private DBConnect() {
        try {
            // JDBC ë“œë¼ì´ë²„ ë¡œë“œ
            Class.forName(DB_DRIVER);
            System.out.println("âœ… MySQL JDBC ë“œë¼ì´ë²„ ë¡œë“œ ì„±ê³µ");
        } catch (ClassNotFoundException e) {
            System.err.println("âŒ JDBC ë“œë¼ì´ë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * DBConnect ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜ (Singleton)
     * @return DBConnect ì¸ìŠ¤í„´ìŠ¤
     */
    public static DBConnect getInstance() {
        if (instance == null) {
            synchronized (DBConnect.class) {
                if (instance == null) {
                    instance = new DBConnect();
                }
            }
        }
        return instance;
    }
    
    /**
     * ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ìƒì„±í•˜ì—¬ ë°˜í™˜
     * @return Connection ê°ì²´
     * @throws SQLException ì—°ê²° ì‹¤íŒ¨ ì‹œ
     */
    public Connection getConnection() throws SQLException {
        if (connection == null || connection.isClosed()) {
            try {
                connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
                System.out.println("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ: " + DB_URL);
            } catch (SQLException e) {
                System.err.println("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨: " + e.getMessage());
                throw e;
            }
        }
        return connection;
    }
    
    /**
     * ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ
     */
    public void closeConnection() {
        if (connection != null) {
            try {
                connection.close();
                System.out.println("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ");
            } catch (SQLException e) {
                System.err.println("âŒ ì—°ê²° ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }
    
    /**
     * PreparedStatement, ResultSet ìë™ ì¢…ë£Œ
     * @param rs ResultSet
     * @param pstmt PreparedStatement
     */
    public void close(ResultSet rs, PreparedStatement pstmt) {
        try {
            if (rs != null && !rs.isClosed()) {
                rs.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        
        try {
            if (pstmt != null && !pstmt.isClosed()) {
                pstmt.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    /**
     * PreparedStatementë§Œ ì¢…ë£Œ
     * @param pstmt PreparedStatement
     */
    public void close(PreparedStatement pstmt) {
        try {
            if (pstmt != null && !pstmt.isClosed()) {
                pstmt.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    /**
     * CallableStatement ì¢…ë£Œ
     * @param cstmt CallableStatement
     */
    public void close(CallableStatement cstmt) {
        try {
            if (cstmt != null && !cstmt.isClosed()) {
                cstmt.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    /**
     * ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
     * @return ì—°ê²° ì„±ê³µ ì—¬ë¶€
     */
    public boolean testConnection() {
        try {
            Connection conn = getConnection();
            if (conn != null && !conn.isClosed()) {
                System.out.println("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!");
                return true;
            }
        } catch (SQLException e) {
            System.err.println("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!");
            e.printStackTrace();
        }
        return false;
    }
    
    /**
     * ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
     */
    public void printConnectionInfo() {
        System.out.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println("  ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´");
        System.out.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println("URL: " + DB_URL);
        System.out.println("User: " + DB_USER);
        System.out.println("Driver: " + DB_DRIVER);
        System.out.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    }
    
    /**
     * ë©”ì¸ ë©”ì„œë“œ - ì—°ê²° í…ŒìŠ¤íŠ¸ìš©
     */
    public static void main(String[] args) {
        DBConnect dbConnect = DBConnect.getInstance();
        
        // ì—°ê²° ì •ë³´ ì¶œë ¥
        dbConnect.printConnectionInfo();
        
        // ì—°ê²° í…ŒìŠ¤íŠ¸
        if (dbConnect.testConnection()) {
            System.out.println("\nğŸ‰ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!");
            
            // í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸
            try {
                Connection conn = dbConnect.getConnection();
                DatabaseMetaData metaData = conn.getMetaData();
                ResultSet tables = metaData.getTables("soulfoodb", null, "%", new String[]{"TABLE"});
                
                System.out.println("\nğŸ“‹ í…Œì´ë¸” ëª©ë¡:");
                while (tables.next()) {
                    System.out.println("  - " + tables.getString("TABLE_NAME"));
                }
                tables.close();
                
            } catch (SQLException e) {
                System.err.println("âŒ í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: " + e.getMessage());
                e.printStackTrace();
            }
            
        } else {
            System.out.println("\nâŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            System.out.println("ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”:");
            System.out.println("1. MySQL ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸");
            System.out.println("2. DB_PASSWORDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸");
            System.out.println("3. soulfoodb ë°ì´í„°ë² ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸");
            System.out.println("4. MySQL JDBC ë“œë¼ì´ë²„ê°€ Build Pathì— ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸");
        }
    }
}
